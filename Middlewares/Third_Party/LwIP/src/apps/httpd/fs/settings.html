<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Bonch-ATS Monitoring — Настройки</title>
<style>
:root{
  --accent:#ff9900;
  --accent-dark:#e68a00;
  --bg:#1c1c1c;
  --panel:#111;
  --panel-2:#2c2c2c;
  --muted:#ccc;
  --white:#ffffff;
  --black:#000000;
}
body{
  margin:0;
  font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
  background:var(--bg);
  color:var(--white);
  display:flex;
  min-height:100vh;
}
nav{
  width:200px;
  background:var(--panel);
  padding-top:20px;
  box-shadow:2px 0 6px rgba(0,0,0,0.6);
  display:flex;
  flex-direction:column;
}
nav a{
  color:var(--white);
  text-decoration:none;
  padding:14px 18px;
  font-size:15px;
  border-left:4px solid transparent;
  margin-bottom:6px;
  transition:background .12s,border-color .12s;
  word-break:break-word;
}
nav a:hover{background:#222;border-left-color:var(--accent);}
nav a.active{background:#222;border-left-color:var(--accent);}
main{flex:1;padding:28px;}
.header{
  font-size:22px;
  color:var(--accent);
  font-weight:700;
  margin-bottom:18px;
}
.card{
  background:var(--panel-2);
  border-radius:12px;
  padding:22px;
  box-shadow:0 6px 18px rgba(0,0,0,0.45);
  max-width:720px;
  margin-bottom:20px;
}
label{
  display:block;
  font-weight:600;
  margin-bottom:6px;
  color:var(--muted);
}
.input{
  width:320px;
  padding:10px 12px;
  border-radius:6px;
  border:0;
  background:#232323;
  color:var(--white);
  font-size:15px;
  margin-bottom:14px;
}
.btn{
  background:var(--accent);
  color:var(--black);
  padding:10px 18px;
  border-radius:10px;
  border:0;
  font-weight:700;
  cursor:pointer;
}
.btn:hover{background:var(--accent-dark);}
.status{margin-top:12px;color:var(--muted);min-height:20px;}
.small{margin-top:8px;color:#9f9f9f;font-size:13px;}
.tabs{display:flex;margin-bottom:20px;}
.tab{
  padding:10px 20px;
  cursor:pointer;
  border-bottom:2px solid transparent;
  margin-right:10px;
  font-weight:600;
}
.tab.active{
  border-bottom:2px solid var(--accent);
  color:var(--accent);
}
.tab-content{display:none;}
.tab-content.active{display:block;}
</style>
</head>
<body>
  <nav>
        <a href="index.html">Главная</a>
        <a href="event.html">Журнал</a>
        <a href="settings.html" class="active">Настройки</a>
        <a href="update.html">Обновление ПО</a>
  </nav>

  <main>
    <div class="header">Bonch-ATS Monitoring — Настройки</div>

    <div class="tabs">
      <div class="tab active" data-tab="network">Сеть</div>
      <div class="tab" data-tab="datetime">Дата и время</div>
      <div class="tab" data-tab="snmp">SNMP</div>
    </div>

    <!-- Сеть -->
    <div class="card tab-content active" id="network">
      <form id="network-form" method="get" action="set_network.cgi">
        <label for="ip">IP-адрес</label>
        <input id="ip" name="ip" class="input" type="text" placeholder="192.168.0.100">

        <label for="mask">Маска сети</label>
        <input id="mask" name="mask" class="input" type="text" placeholder="255.255.255.0">

        <label for="gateway">Шлюз (Gateway)</label>
        <input id="gateway" name="gateway" class="input" type="text" placeholder="192.168.0.1">

        <label>
          <input id="dhcp" name="dhcp" type="checkbox" value="on">
          Использовать DHCP
        </label>

        <div style="margin-top:12px;">
          <button type="submit" class="btn">Сохранить</button>
        </div>
        <div id="status-network" class="status"></div>
      </form>
    </div>

    <!-- Дата и время -->
    <div class="card tab-content" id="datetime">
      <form id="datetime-form" method="get" action="">
        <label for="date">Дата</label>
        <input id="date" name="date" class="input" type="date">

        <label for="time">Время</label>
        <input id="time" name="time" class="input" type="time">

        <div style="margin-top:12px;">
          <button type="submit" class="btn">Сохранить дату и время</button>
        </div>
        <div id="status-datetime" class="status"></div>
      </form>
    </div>

    <!-- SNMP -->
    <div class="card tab-content" id="snmp">
      <form id="snmp-form" method="get" action="set_snmp.cgi">
        <label for="snmp-read">Пароль (community) на чтение</label>
        <input id="snmp-read" name="snmp-read" class="input" type="text" placeholder="public">

        <label for="snmp-write">Пароль (community) на запись</label>
        <input id="snmp-write" name="snmp-write" class="input" type="text" placeholder="private">

        <label for="snmp-trap">Пароль (community) на trap/inform</label>
        <input id="snmp-trap" name="snmp-trap" class="input" type="text" placeholder="public">

        <div style="margin-top:12px;">
          <button type="submit" class="btn">Сохранить</button>
        </div>
        <div id="status-snmp" class="status"></div>
      </form>
    </div>
  </main>

<script>
(function(){
  // вкладки
  const tabs = document.querySelectorAll('.tab');
  const contents = document.querySelectorAll('.tab-content');
  tabs.forEach(tab=>{
    tab.addEventListener('click', ()=>{
      tabs.forEach(t=>t.classList.remove('active'));
      contents.forEach(c=>c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
    });
  });

  // формы
  const forms = [
    {id:'network-form', status:'status-network'},
    {id:'snmp-form', status:'status-snmp'}
  ];

  forms.forEach(f=>{
    const form = document.getElementById(f.id);
    const status = document.getElementById(f.status);
    form.addEventListener('submit', ev=>{
      ev.preventDefault();
      const data = new URLSearchParams(new FormData(form)).toString();
      location.href = form.action + '?' + data;
    });
  });

  // Дата и время через два CGI - ИСПРАВЛЕННЫЙ КОД
  const datetimeForm = document.getElementById('datetime-form');
  const statusDatetime = document.getElementById('status-datetime');
  datetimeForm.addEventListener('submit', ev=>{
    ev.preventDefault();
    
    const formData = new FormData(datetimeForm);
    const dateValue = formData.get('date');
    const timeValue = formData.get('time');
    
    statusDatetime.textContent = "Сохранение...";
    
    // Отправляем дату отдельным CGI
    if(dateValue) {
      // Простой GET запрос без кодирования
      const dateImg = new Image();
      dateImg.src = 'set_date.cgi?date=' + dateValue;
    }
    
    // Отправляем время отдельным CGI
    if(timeValue) {
      // Простой GET запрос без кодирования
      const timeImg = new Image();
      timeImg.src = 'set_time.cgi?time=' + timeValue;
    }
    
    statusDatetime.textContent = "Дата и время сохранены!";
    
    // Обновляем страницу через секунду
    setTimeout(() => {
      location.reload();
    }, 1000);
  });

  // загрузка сетевых данных и datetime
  async function loadSettings(){
    try{
      const resp = await fetch('/table.shtml',{cache:'no-store'});
      if(!resp.ok) throw new Error('HTTP '+resp.status);
      const html = await resp.text();

      // сеть
      const ipMatch = html.match(/<!--#netip-->(.*?)<\/td>/s);
      const maskMatch = html.match(/<!--#netmask-->(.*?)<\/td>/s);
      const gwMatch = html.match(/<!--#netgw-->(.*?)<\/td>/s);
      const dhcpMatch = html.match(/<!--#netdhcp-->(.*?)<\/td>/s);
      if(ipMatch) document.getElementById('ip').placeholder = ipMatch[1].trim();
      if(maskMatch) document.getElementById('mask').placeholder = maskMatch[1].trim();
      if(gwMatch) document.getElementById('gateway').placeholder = gwMatch[1].trim();
      if(dhcpMatch) document.getElementById('dhcp').checked = (dhcpMatch[1].trim()==='on');

      // дата и время
      const dateMatch = html.match(/<!--#date-->(.*?)<\/td>/s);
      const timeMatch = html.match(/<!--#time-->(.*?)<\/td>/s);
      if(dateMatch) document.getElementById('date').value = dateMatch[1].trim();
      if(timeMatch) document.getElementById('time').value = timeMatch[1].trim();

      // SNMP
      const readMatch = html.match(/<!--#snmp-read-->(.*?)<\/td>/s);
      const writeMatch = html.match(/<!--#snmp-write-->(.*?)<\/td>/s);
      const trapMatch = html.match(/<!--#snmp-trap-->(.*?)<\/td>/s);
      if(readMatch) document.getElementById('snmp-read').value = readMatch[1].trim();
      if(writeMatch) document.getElementById('snmp-write').value = writeMatch[1].trim();
      if(trapMatch) document.getElementById('snmp-trap').value = trapMatch[1].trim();
    }catch(err){
      console.error(err);
    }
  }

  loadSettings();
})();
</script>
</body>
</html>