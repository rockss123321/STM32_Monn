<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Bonch-ATS Monitoring — Настройки</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <nav>
    <a href="index.html">Главная</a>
    <a href="event.html">Журнал</a>
    <a href="settings.html" class="active">Настройки</a>
    <a href="update.html">Обновление ПО</a>
  </nav>

  <main>
    <div class="header">Bonch-ATS Monitoring — Настройки</div>

      <div class="tabs">
      <div class="tab active" data-tab="network">Сеть</div>
      <div class="tab" data-tab="datetime">Дата и время</div>
        <div class="tab" data-tab="snmp">SNMP</div>
        <div class="tab" data-tab="creds">Логин</div>
    </div>

    <!-- Сеть -->
    <div class="card tab-content active" id="network">
      <form id="network-form" method="get" action="set_network.cgi">
        <label for="ip">IP-адрес</label>
        <input id="ip" name="ip" class="input" type="text" placeholder="192.168.0.100">

        <label for="mask">Маска сети</label>
        <input id="mask" name="mask" class="input" type="text" placeholder="255.255.255.0">

        <label for="gateway">Шлюз (Gateway)</label>
        <input id="gateway" name="gateway" class="input" type="text" placeholder="192.168.0.1">

        <label>
          <input id="dhcp" name="dhcp" type="checkbox" value="on">
          Использовать DHCP
        </label>

        <div style="margin-top:12px;">
          <button type="submit" class="btn">Сохранить</button>
        </div>
        <div id="status-network" class="status"></div>
      </form>
    </div>

    <!-- Дата и время -->
    <div class="card tab-content" id="datetime">
      <form id="datetime-form" method="get" action="">
        <label for="date">Дата</label>
        <input id="date" name="date" class="input" type="date">

        <label for="time">Время</label>
        <input id="time" name="time" class="input" type="time">

        <div style="margin-top:12px;">
          <button type="submit" class="btn">Сохранить дату и время</button>
        </div>
        <div id="status-datetime" class="status"></div>
      </form>
    </div>

    <!-- SNMP -->
    <div class="card tab-content" id="snmp">
      <form id="snmp-form" method="get" action="set_snmp.cgi">
        <label for="snmp-read">Пароль (community) на чтение</label>
        <input id="snmp-read" name="snmp-read" class="input" type="text" placeholder="public">

        <label for="snmp-write">Пароль (community) на запись</label>
        <input id="snmp-write" name="snmp-write" class="input" type="text" placeholder="private">

        <label for="snmp-trap">Пароль (community) на trap/inform</label>
        <input id="snmp-trap" name="snmp-trap" class="input" type="text" placeholder="public">

        <div style="margin-top:12px;">
          <button type="submit" class="btn">Сохранить</button>
        </div>
        <div id="status-snmp" class="status"></div>
      </form>
    </div>

      <!-- Логин/пароль -->
      <div class="card tab-content" id="creds">
        <form id="creds-form" method="get" action="set_creds.cgi">
          <label for="login-user">Логин (до 8 символов)</label>
          <input id="login-user" name="user" class="input" type="text" maxlength="8" placeholder="admin">

          <label for="login-pass">Пароль (до 8 символов)</label>
          <input id="login-pass" name="pass" class="input" type="text" maxlength="8" placeholder="admin">

          <div style="margin-top:12px;">
            <button type="submit" class="btn">Сохранить</button>
          </div>
          <div id="status-creds" class="status"></div>
        </form>
      </div>
  </main>

  <script>
    (function () {
      // вкладки
      const tabs = document.querySelectorAll('.tab');
      const contents = document.querySelectorAll('.tab-content');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          contents.forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.dataset.tab).classList.add('active');
        });
      });

      // формы
      const forms = [
        { id: 'network-form', status: 'status-network' },
        { id: 'snmp-form', status: 'status-snmp' },
        { id: 'creds-form', status: 'status-creds' }
      ];

      forms.forEach(f => {
        const form = document.getElementById(f.id);
        const status = document.getElementById(f.status);
        form.addEventListener('submit', ev => {
          ev.preventDefault();
          const data = new URLSearchParams(new FormData(form)).toString();
          location.href = form.action + '?' + data;
        });
      });

      // Дата и время через два CGI - ИСПРАВЛЕННЫЙ КОД
      const datetimeForm = document.getElementById('datetime-form');
      const statusDatetime = document.getElementById('status-datetime');
      datetimeForm.addEventListener('submit', ev => {
        ev.preventDefault();

        const formData = new FormData(datetimeForm);
        const dateValue = formData.get('date');
        const timeValue = formData.get('time');

        statusDatetime.textContent = "Сохранение...";

        // Отправляем дату отдельным CGI
        if (dateValue) {
          // Простой GET запрос без кодирования
          const dateImg = new Image();
          dateImg.src = 'set_date.cgi?date=' + dateValue;
        }

        // Отправляем время отдельным CGI
        if (timeValue) {
          // Простой GET запрос без кодирования
          const timeImg = new Image();
          timeImg.src = 'set_time.cgi?time=' + timeValue;
        }

        statusDatetime.textContent = "Дата и время сохранены!";

        // Обновляем страницу через секунду
        setTimeout(() => {
          location.reload();
        }, 1000);
      });

      // загрузка сетевых данных и datetime
      async function loadSettings() {
        try {
          const resp = await fetch('/table.shtml', { cache: 'no-store' });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          const html = await resp.text();

          // сеть
          const ipMatch = html.match(/<!--#netip-->(.*?)<\/td>/s);
      const maskMatch = html.match(/<!--#netmask-->(.*?)<\/td>/s);
          const gwMatch = html.match(/<!--#netgw-->(.*?)<\/td>/s);
          const dhcpMatch = html.match(/<!--#netdhcp-->(.*?)<\/td>/s);
          if (ipMatch) document.getElementById('ip').placeholder = ipMatch[1].trim();
          if (maskMatch) document.getElementById('mask').placeholder = maskMatch[1].trim();
          if (gwMatch) document.getElementById('gateway').placeholder = gwMatch[1].trim();
          if (dhcpMatch) document.getElementById('dhcp').checked = (dhcpMatch[1].trim() === 'on');

          // дата и время
          const dateMatch = html.match(/<!--#date-->(.*?)<\/td>/s);
          const timeMatch = html.match(/<!--#time-->(.*?)<\/td>/s);
          if (dateMatch) document.getElementById('date').value = dateMatch[1].trim();
          if (timeMatch) document.getElementById('time').value = timeMatch[1].trim();

          // SNMP
          const readMatch = html.match(/<!--#snmp-read-->(.*?)<\/td>/s);
          const writeMatch = html.match(/<!--#snmp-write-->(.*?)<\/td>/s);
          const trapMatch = html.match(/<!--#snmp-trap-->(.*?)<\/td>/s);
          if (readMatch) document.getElementById('snmp-read').value = readMatch[1].trim();
          if (writeMatch) document.getElementById('snmp-write').value = writeMatch[1].trim();
          if (trapMatch) document.getElementById('snmp-trap').value = trapMatch[1].trim();

          // Логин/пароль — не подставляем значения для безопасности
        } catch (err) {
          console.error(err);
        }
      }

      loadSettings();
    })();
  </script>
</body>

</html>